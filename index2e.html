<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TRACER Editor</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    --bg:       #f7f8fc;
    --surface:  #ffffff;
    --surface2: #f0f2f9;
    --border:   #dde1f0;
    --accent:   #5a48e0;
    --accent-h: #7c6af7;
    --danger:   #e0483a;
    --success:  #2d9e6b;
    --text:     #1e1e30;
    --text-dim: #6b7099;
    --he:       #0288d1;
    --ru:       #c62828;
    --en:       #2e7d32;
    --ar:       #6a1b9a;
    --shadow:   0 2px 12px rgba(0,0,0,0.08);
}

body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
}

/* â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.topbar {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    height: 56px;
    display: flex;
    align-items: center;
    gap: 16px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow);
}

.topbar-logo {
    font-family: 'Space Mono', monospace;
    font-weight: 700;
    font-size: 1.05em;
    color: var(--accent);
    letter-spacing: 0.05em;
    flex-shrink: 0;
}

.topbar-sep { flex: 1; }

.topbar-actions { display: flex; gap: 8px; align-items: center; }

/* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 0.875em;
    font-weight: 500;
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    border: none;
    transition: all 0.15s;
    white-space: nowrap;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-h); }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
.btn-outline:hover { border-color: var(--accent); color: var(--accent); background: rgba(90,72,224,0.05); }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover { opacity: 0.85; }
.btn-success { background: var(--success); color: #fff; }
.btn-success:hover { opacity: 0.85; }
.btn-sm { padding: 5px 11px; font-size: 0.8em; border-radius: 6px; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }

/* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    height: calc(100vh - 56px);
}

/* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.sidebar-header {
    padding: 16px;
    border-bottom: 1px solid var(--border);
}

.sidebar-header h3 {
    font-size: 0.8em;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-dim);
    margin-bottom: 10px;
}

.file-select-group {
    display: flex;
    gap: 6px;
}

.file-btn {
    flex: 1;
    padding: 8px 6px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--surface2);
    font-size: 0.8em;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
    color: var(--text-dim);
}
.file-btn:hover { border-color: var(--accent); color: var(--accent); }
.file-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

.sidebar-search {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
}

.search-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.875em;
    background: var(--surface2);
    color: var(--text);
    outline: none;
}
.search-input:focus { border-color: var(--accent); }
.search-input::placeholder { color: var(--text-dim); }

.question-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
}

.q-item {
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s;
    margin-bottom: 2px;
    border: 1px solid transparent;
}
.q-item:hover { background: var(--surface2); }
.q-item.active { background: rgba(90,72,224,0.08); border-color: rgba(90,72,224,0.25); }

.q-item-id {
    font-family: 'Space Mono', monospace;
    font-size: 0.7em;
    color: var(--text-dim);
    margin-bottom: 3px;
}
.q-item-preview {
    font-size: 0.82em;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.4;
}

.q-item.modified .q-item-id::after {
    content: ' â—';
    color: var(--accent);
}

.empty-state {
    text-align: center;
    color: var(--text-dim);
    font-size: 0.875em;
    padding: 32px 16px;
}

.sidebar-footer {
    padding: 12px 16px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 6px;
}

/* â”€â”€ MAIN EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.editor-main {
    overflow-y: auto;
    background: var(--bg);
}

.editor-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-dim);
    gap: 12px;
    text-align: center;
    padding: 32px;
}
.editor-placeholder .icon { font-size: 3em; }
.editor-placeholder p { font-size: 0.9em; line-height: 1.6; }

.editor-panel {
    max-width: 820px;
    margin: 0 auto;
    padding: 24px;
}

/* Question meta bar */
.q-meta-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 18px;
    box-shadow: var(--shadow);
}

.q-id-badge {
    font-family: 'Space Mono', monospace;
    font-size: 0.85em;
    background: var(--accent);
    color: #fff;
    padding: 4px 12px;
    border-radius: 20px;
    flex-shrink: 0;
}

.q-id-input {
    font-family: 'Space Mono', monospace;
    font-size: 0.9em;
    width: 80px;
    padding: 5px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--surface2);
    color: var(--text);
    flex-shrink: 0;
}

.q-meta-sep { flex: 1; }

/* Language cards */
.lang-cards { display: flex; flex-direction: column; gap: 16px; }

.lang-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow);
}

.lang-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 18px;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
}

.lang-flag { font-size: 1.3em; }

.lang-name {
    font-weight: 600;
    font-size: 0.9em;
}

.lang-card.he .lang-name { color: var(--he); }
.lang-card.ru .lang-name { color: var(--ru); }
.lang-card.en .lang-name { color: var(--en); }
.lang-card.ar .lang-name { color: var(--ar); }
.lang-card.he .lang-card-header { border-left: 3px solid var(--he); }
.lang-card.ru .lang-card-header { border-left: 3px solid var(--ru); }
.lang-card.en .lang-card-header { border-left: 3px solid var(--en); }
.lang-card.ar .lang-card-header { border-left: 3px solid var(--ar); }

.lang-badge {
    font-family: 'Space Mono', monospace;
    font-size: 0.7em;
    padding: 2px 8px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}
.he .lang-badge { background: rgba(2,136,209,0.12); color: var(--he); }
.ru .lang-badge { background: rgba(198,40,40,0.1); color: var(--ru); }
.en .lang-badge { background: rgba(46,125,50,0.1); color: var(--en); }
.ar .lang-badge { background: rgba(106,27,154,0.1); color: var(--ar); }

/* RTL fields */
.lang-card.he textarea, .lang-card.ar textarea { direction: rtl; font-family: 'Inter', sans-serif; }

.lang-card-body { padding: 16px 18px; display: flex; flex-direction: column; gap: 12px; }

.field-label {
    font-size: 0.75em;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-dim);
    margin-bottom: 5px;
}

textarea {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.9em;
    line-height: 1.6;
    color: var(--text);
    background: var(--surface2);
    resize: vertical;
    min-height: 80px;
    font-family: 'Inter', sans-serif;
    transition: border-color 0.15s;
    outline: none;
}
textarea:focus { border-color: var(--accent); background: #fff; }

/* Media section */
.media-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow);
    margin-top: 4px;
}

.media-section-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 18px;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
    cursor: pointer;
    user-select: none;
}
.media-section-header:hover { background: var(--border); }

.media-toggle-icon { transition: transform 0.2s; font-size: 0.8em; color: var(--text-dim); }
.media-section.open .media-toggle-icon { transform: rotate(90deg); }

.media-section-title { font-weight: 600; font-size: 0.88em; flex: 1; }
.media-count { font-family: 'Space Mono', monospace; font-size: 0.75em; color: var(--text-dim); }

.media-body { padding: 16px 18px; display: none; flex-direction: column; gap: 12px; }
.media-section.open .media-body { display: flex; }

.media-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    position: relative;
}

.media-item-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
}

.media-type-badge {
    font-size: 0.7em;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 4px;
    text-transform: uppercase;
}
.type-image { background: rgba(2,136,209,0.12); color: #0288d1; }
.type-link  { background: rgba(90,72,224,0.12); color: var(--accent); }
.type-note  { background: rgba(229,192,123,0.2); color: #8a6200; }

.media-remove {
    margin-left: auto;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-dim);
    font-size: 1em;
    padding: 2px 6px;
    border-radius: 4px;
    transition: all 0.15s;
}
.media-remove:hover { background: rgba(224,72,58,0.1); color: var(--danger); }

.media-field { margin-bottom: 8px; }
.media-field:last-child { margin-bottom: 0; }

.media-input {
    width: 100%;
    padding: 7px 11px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.85em;
    color: var(--text);
    background: var(--surface);
    font-family: 'Inter', sans-serif;
    outline: none;
    transition: border-color 0.15s;
}
.media-input:focus { border-color: var(--accent); }

.add-media-btns { display: flex; gap: 8px; flex-wrap: wrap; }

/* Toast */
.toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--text);
    color: #fff;
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 0.875em;
    font-weight: 500;
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    z-index: 9999;
    transform: translateY(0);
    transition: all 0.3s;
    max-width: 320px;
}
.toast.hidden { transform: translateY(20px); opacity: 0; pointer-events: none; }
.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
.toast.info { background: var(--accent); }

/* Stats bar */
.stats-bar {
    display: flex;
    gap: 16px;
    padding: 0 16px 12px;
    font-size: 0.78em;
    color: var(--text-dim);
}
.stats-bar span { display: flex; align-items: center; gap: 4px; }

/* Divider */
.section-divider {
    font-size: 0.75em;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-dim);
    margin: 20px 0 12px;
    display: flex;
    align-items: center;
    gap: 10px;
}
.section-divider::before, .section-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
}

/* ID Jump input */
.id-jump { display: flex; gap: 6px; align-items: center; padding: 8px 16px; border-bottom: 1px solid var(--border); }
.id-jump input { 
    width: 70px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px;
    font-family: 'Space Mono', monospace; font-size: 0.8em; background: var(--surface2); color: var(--text); outline: none;
}
.id-jump input:focus { border-color: var(--accent); }
.id-jump label { font-size: 0.8em; color: var(--text-dim); }

/* Nav arrows */
.q-nav { display: flex; gap: 6px; align-items: center; }
.q-nav-pos { font-family: 'Space Mono', monospace; font-size: 0.78em; color: var(--text-dim); }
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
    <div class="topbar-logo">TRACER // EDITOR</div>
    <div class="topbar-sep"></div>
    <div class="topbar-actions">
        <span id="fileIndicator" style="font-size:0.8em; color:var(--text-dim);">No file loaded</span>
        <button class="btn btn-outline" onclick="loadFromGitHub()" id="loadBtn">â¬‡ Load from GitHub</button>
        <button class="btn btn-success" onclick="downloadJSON()" id="saveBtn" disabled>â¬‡ Download JSON</button>
        <button class="btn btn-primary" onclick="copyJSON()" id="copyBtn" disabled>ğŸ“‹ Copy JSON</button>
    </div>
</div>

<div class="layout">

<!-- SIDEBAR -->
<div class="sidebar">
    <div class="sidebar-header">
        <h3>Data file</h3>
        <div class="file-select-group">
            <button class="file-btn" data-file="doctor" onclick="switchFile('doctor', this)">ğŸ‘¨â€âš•ï¸ Doctor</button>
            <button class="file-btn" data-file="nurse" onclick="switchFile('nurse', this)">ğŸ‘©â€âš•ï¸ Nurse</button>
            <button class="file-btn" data-file="support" onclick="switchFile('support', this)">ğŸ§‘â€ğŸ”¬ Support</button>
        </div>
    </div>

    <div class="id-jump" id="idJumpBar" style="display:none;">
        <label for="idJumpInput">Jump to ID:</label>
        <input type="number" id="idJumpInput" min="1" placeholder="ID">
        <button class="btn btn-outline btn-sm" onclick="jumpToId()">Go</button>
    </div>

    <div class="sidebar-search" id="searchBar" style="display:none;">
        <input class="search-input" id="searchInput" type="text" placeholder="ğŸ” Search questionsâ€¦" oninput="renderList()">
    </div>

    <div class="stats-bar" id="statsBar" style="display:none;">
        <span id="totalCount">0 questions</span>
        <span id="modCount" style="color:var(--accent)"></span>
    </div>

    <div class="question-list" id="questionList">
        <div class="empty-state">
            <div>ğŸ“‚</div>
            <div>Select a file and load data<br>from GitHub or upload a local file</div>
        </div>
    </div>

    <div class="sidebar-footer" id="sidebarFooter" style="display:none;">
        <button class="btn btn-outline btn-sm" style="flex:1;" onclick="addNewQuestion()">+ Add question</button>
        <button class="btn btn-danger btn-sm" onclick="deleteCurrentQuestion()" id="deleteBtn" disabled>ğŸ—‘</button>
    </div>
</div>

<!-- MAIN EDITOR -->
<div class="editor-main" id="editorMain">
    <div class="editor-placeholder">
        <div class="icon">âœï¸</div>
        <p>Load a data file to start editing.<br>Select <strong>Doctor</strong>, <strong>Nurse</strong>, or <strong>Support</strong> above,<br>then click <strong>Load from GitHub</strong>.</p>
        <p style="margin-top:12px; font-size:0.8em;">Or <label for="localFileInput" style="color:var(--accent); cursor:pointer; text-decoration:underline;">open a local JSON file</label>.</p>
        <input type="file" id="localFileInput" accept=".json" style="display:none;" onchange="loadLocalFile(event)">
    </div>
</div>

</div><!-- /layout -->

<div class="toast hidden" id="toast"></div>

<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GITHUB_BASE = 'https://raw.githubusercontent.com/StarleyBy/tracer-2025/main/data/';

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentFile   = 'doctor';
let questions     = [];          // array of question objects
let currentIndex  = -1;          // index in questions[] of selected question
let modifiedIds   = new Set();   // set of question IDs that were modified

// â”€â”€â”€ LANGUAGE CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LANGS = [
    { code:'he', name:'×¢×‘×¨×™×ª (Hebrew)',  flag:'ğŸ‡®ğŸ‡±', dir:'rtl' },
    { code:'ru', name:'Ğ ÑƒÑÑĞºĞ¸Ğ¹',         flag:'ğŸ‡·ğŸ‡º', dir:'ltr' },
    { code:'en', name:'English',         flag:'ğŸ‡ºğŸ‡¸', dir:'ltr' },
    { code:'ar', name:'Ø¹Ø±Ø¨ÙŠ (Arabic)',   flag:'ğŸ‡¸ğŸ‡¦', dir:'rtl' },
];

// â”€â”€â”€ FILE SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchFile(name, btn) {
    if (questions.length && modifiedIds.size > 0) {
        if (!confirm('You have unsaved changes. Switch file anyway?')) return;
    }
    currentFile = name;
    questions = [];
    currentIndex = -1;
    modifiedIds.clear();
    document.querySelectorAll('.file-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('fileIndicator').textContent = `${name}.json â€” not loaded`;
    renderList();
    showPlaceholder();
    toggleUI(false);
    document.getElementById('saveBtn').disabled = true;
    document.getElementById('copyBtn').disabled = true;
}

function toggleUI(show) {
    ['idJumpBar','searchBar','statsBar','sidebarFooter'].forEach(id => {
        document.getElementById(id).style.display = show ? (id === 'statsBar' ? 'flex' : 'flex') : 'none';
    });
}

// â”€â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadFromGitHub() {
    const btn = document.getElementById('loadBtn');
    btn.disabled = true;
    btn.textContent = 'â³ Loadingâ€¦';
    try {
        const res = await fetch(GITHUB_BASE + currentFile + '.json?v=' + Date.now());
        if (!res.ok) throw new Error('HTTP ' + res.status);
        questions = await res.json();
        modifiedIds.clear();
        finishLoad();
        toast('Loaded ' + questions.length + ' questions from GitHub', 'success');
    } catch(e) {
        toast('Error: ' + e.message + '. Try loading a local file.', 'error');
    }
    btn.disabled = false;
    btn.textContent = 'â¬‡ Load from GitHub';
}

function loadLocalFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        try {
            questions = JSON.parse(e.target.result);
            modifiedIds.clear();
            // Auto-detect file type from filename
            const name = file.name.replace('.json','').toLowerCase();
            if (['doctor','nurse','support'].includes(name)) {
                currentFile = name;
                document.querySelectorAll('.file-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`[data-file="${name}"]`).classList.add('active');
            }
            finishLoad();
            toast('Loaded ' + questions.length + ' questions from file', 'success');
        } catch(err) {
            toast('Invalid JSON file', 'error');
        }
    };
    reader.readAsText(file);
}

function finishLoad() {
    currentIndex = -1;
    document.getElementById('fileIndicator').textContent = `${currentFile}.json â€” ${questions.length} questions`;
    document.getElementById('saveBtn').disabled = false;
    document.getElementById('copyBtn').disabled = false;
    toggleUI(true);
    renderList();
    updateStats();
    showPlaceholder();
}

// â”€â”€â”€ QUESTION LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderList() {
    const listEl = document.getElementById('questionList');
    const query  = (document.getElementById('searchInput')?.value || '').toLowerCase();

    if (!questions.length) {
        listEl.innerHTML = '<div class="empty-state"><div>ğŸ“‚</div><div>No questions loaded</div></div>';
        return;
    }

    const filtered = questions.filter((q, i) => {
        if (!query) return true;
        const text = JSON.stringify(q).toLowerCase();
        return text.includes(query) || String(q.id).includes(query);
    });

    listEl.innerHTML = filtered.map((q, fi) => {
        const realIdx = questions.indexOf(q);
        const preview = q.en?.question || q.ru?.question || q.he?.question || '(no text)';
        const isMod   = modifiedIds.has(q.id);
        const isActive = realIdx === currentIndex;
        return `<div class="q-item${isActive ? ' active' : ''}${isMod ? ' modified' : ''}"
                     onclick="selectQuestion(${realIdx})">
            <div class="q-item-id">#${q.id}</div>
            <div class="q-item-preview">${escHtml(preview)}</div>
        </div>`;
    }).join('');
}

function updateStats() {
    document.getElementById('totalCount').textContent = questions.length + ' questions';
    const mc = modifiedIds.size;
    document.getElementById('modCount').textContent = mc ? `${mc} modified` : '';
}

// â”€â”€â”€ SELECT / EDIT QUESTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectQuestion(idx) {
    // Save current before switching
    if (currentIndex >= 0) saveCurrentToMemory();

    currentIndex = idx;
    const q = questions[idx];
    renderEditor(q);
    renderList();
    document.getElementById('deleteBtn').disabled = false;
}

function renderEditor(q) {
    const main = document.getElementById('editorMain');

    const totalIdx = questions.indexOf(q) + 1;
    const total    = questions.length;

    main.innerHTML = `
    <div class="editor-panel">

        <!-- Meta bar -->
        <div class="q-meta-bar">
            <span style="font-size:0.8em; color:var(--text-dim); font-weight:600;">ID</span>
            <input class="q-id-input" id="editId" type="number" value="${q.id}" min="1"
                   title="Question ID (used for referencing)">
            <div class="q-meta-sep"></div>
            <div class="q-nav">
                <button class="btn btn-outline btn-sm" onclick="navigateQ(-1)" ${totalIdx <= 1 ? 'disabled' : ''}>â† Prev</button>
                <span class="q-nav-pos">${totalIdx} / ${total}</span>
                <button class="btn btn-outline btn-sm" onclick="navigateQ(1)" ${totalIdx >= total ? 'disabled' : ''}>Next â†’</button>
            </div>
        </div>

        <!-- Language cards -->
        <div class="section-divider">Question & Answer text</div>
        <div class="lang-cards" id="langCards">
            ${LANGS.map(l => renderLangCard(l, q)).join('')}
        </div>

        <!-- Media sections -->
        <div class="section-divider">Media (optional)</div>

        <div id="mediaQSection">
            ${renderMediaSection('question_media', q.question_media || [], 'Question media')}
        </div>
        <div style="margin-top:12px;" id="mediaASection">
            ${renderMediaSection('answer_media', q.answer_media || [], 'Answer media')}
        </div>

    </div>`;
}

function renderLangCard(lang, q) {
    const data = q[lang.code] || {};
    return `
    <div class="lang-card ${lang.code}">
        <div class="lang-card-header">
            <span class="lang-flag">${lang.flag}</span>
            <span class="lang-name">${lang.name}</span>
            <span class="lang-badge">${lang.code.toUpperCase()}</span>
        </div>
        <div class="lang-card-body">
            <div>
                <div class="field-label">Question</div>
                <textarea id="q_${lang.code}" rows="3" dir="${lang.dir}"
                    oninput="markModified()">${escHtml(data.question || '')}</textarea>
            </div>
            <div>
                <div class="field-label">Answer</div>
                <textarea id="a_${lang.code}" rows="3" dir="${lang.dir}"
                    oninput="markModified()">${escHtml(data.answer || '')}</textarea>
            </div>
        </div>
    </div>`;
}

function renderMediaSection(fieldKey, items, title) {
    const count = items.length;
    return `
    <div class="media-section" id="ms_${fieldKey}">
        <div class="media-section-header" onclick="toggleMediaSection('ms_${fieldKey}')">
            <span class="media-toggle-icon">â–¶</span>
            <span class="media-section-title">${title}</span>
            <span class="media-count">${count} item${count !== 1 ? 's' : ''}</span>
        </div>
        <div class="media-body" id="mb_${fieldKey}">
            <div id="mi_${fieldKey}">
                ${items.map((item, i) => renderMediaItem(fieldKey, item, i)).join('')}
            </div>
            <div class="add-media-btns">
                <button class="btn btn-outline btn-sm" onclick="addMediaItem('${fieldKey}','image')">ğŸ–¼ Add image</button>
                <button class="btn btn-outline btn-sm" onclick="addMediaItem('${fieldKey}','link')">ğŸ”— Add link</button>
                <button class="btn btn-outline btn-sm" onclick="addMediaItem('${fieldKey}','note')">ğŸ“ Add note</button>
            </div>
        </div>
    </div>`;
}

function renderMediaItem(fieldKey, item, idx) {
    const typeClass = 'type-' + item.type;
    const typeLabel = item.type.toUpperCase();

    let fields = '';
    if (item.type === 'image') {
        fields = `
            <div class="media-field">
                <div class="field-label" style="font-size:0.72em;">Image URL or path</div>
                <input class="media-input" data-key="${fieldKey}" data-idx="${idx}" data-prop="src"
                       value="${escHtml(item.src || '')}" placeholder="images/doctor/q1.png"
                       oninput="mediaFieldChanged(this)">
            </div>
            <div class="media-field">
                <div class="field-label" style="font-size:0.72em;">Alt text</div>
                <input class="media-input" data-key="${fieldKey}" data-idx="${idx}" data-prop="alt"
                       value="${escHtml(item.alt || '')}" placeholder="Description for accessibility"
                       oninput="mediaFieldChanged(this)">
            </div>`;
    } else if (item.type === 'link') {
        fields = `
            <div class="media-field">
                <div class="field-label" style="font-size:0.72em;">URL</div>
                <input class="media-input" data-key="${fieldKey}" data-idx="${idx}" data-prop="url"
                       value="${escHtml(item.url || '')}" placeholder="https://example.com"
                       oninput="mediaFieldChanged(this)">
            </div>
            ${LANGS.map(l => `
            <div class="media-field">
                <div class="field-label" style="font-size:0.72em;">Label ${l.flag} ${l.code.toUpperCase()}</div>
                <input class="media-input" data-key="${fieldKey}" data-idx="${idx}" data-prop="labels.${l.code}"
                       value="${escHtml((item.labels || {})[l.code] || '')}" placeholder="Link label in ${l.code}"
                       dir="${l.dir}" oninput="mediaFieldChanged(this)">
            </div>`).join('')}`;
    } else if (item.type === 'note') {
        fields = LANGS.map(l => `
            <div class="media-field">
                <div class="field-label" style="font-size:0.72em;">Note ${l.flag} ${l.code.toUpperCase()}</div>
                <textarea class="media-input" data-key="${fieldKey}" data-idx="${idx}" data-prop="text.${l.code}"
                          rows="2" dir="${l.dir}" placeholder="Note in ${l.code}"
                          oninput="mediaFieldChanged(this)">${escHtml((item.text || {})[l.code] || '')}</textarea>
            </div>`).join('');
    }

    return `
    <div class="media-item" id="mi_${fieldKey}_${idx}">
        <div class="media-item-header">
            <span class="media-type-badge ${typeClass}">${typeLabel}</span>
            <button class="media-remove" onclick="removeMediaItem('${fieldKey}', ${idx})" title="Remove">âœ•</button>
        </div>
        ${fields}
    </div>`;
}

function toggleMediaSection(id) {
    document.getElementById(id).classList.toggle('open');
}

// â”€â”€â”€ MEDIA ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addMediaItem(fieldKey, type) {
    if (currentIndex < 0) return;
    const q = questions[currentIndex];
    if (!q[fieldKey]) q[fieldKey] = [];

    let newItem;
    if (type === 'image') newItem = { type:'image', src:'', alt:'' };
    else if (type === 'link') newItem = { type:'link', url:'', labels:{ he:'', ru:'', en:'', ar:'' } };
    else newItem = { type:'note', text:{ he:'', ru:'', en:'', ar:'' } };

    q[fieldKey].push(newItem);
    markModified();

    // Re-render just that media section
    const sectionId = fieldKey === 'question_media' ? 'mediaQSection' : 'mediaASection';
    document.getElementById(sectionId).innerHTML =
        renderMediaSection(fieldKey, q[fieldKey], fieldKey === 'question_media' ? 'Question media' : 'Answer media');

    // Open section
    document.getElementById('ms_' + fieldKey).classList.add('open');
}

function removeMediaItem(fieldKey, idx) {
    if (currentIndex < 0) return;
    const q = questions[currentIndex];
    q[fieldKey].splice(idx, 1);
    markModified();
    const sectionId = fieldKey === 'question_media' ? 'mediaQSection' : 'mediaASection';
    document.getElementById(sectionId).innerHTML =
        renderMediaSection(fieldKey, q[fieldKey], fieldKey === 'question_media' ? 'Question media' : 'Answer media');
    document.getElementById('ms_' + fieldKey).classList.add('open');
}

function mediaFieldChanged(input) {
    if (currentIndex < 0) return;
    const q    = questions[currentIndex];
    const fkey = input.dataset.key;
    const idx  = parseInt(input.dataset.idx);
    const prop = input.dataset.prop;
    const val  = input.value;

    if (prop.includes('.')) {
        const [parent, child] = prop.split('.');
        if (!q[fkey][idx][parent]) q[fkey][idx][parent] = {};
        q[fkey][idx][parent][child] = val;
    } else {
        q[fkey][idx][prop] = val;
    }
    markModified();
}

// â”€â”€â”€ SAVE TO MEMORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveCurrentToMemory() {
    if (currentIndex < 0 || currentIndex >= questions.length) return;
    const q = questions[currentIndex];

    // ID
    const newId = parseInt(document.getElementById('editId')?.value);
    if (newId && newId !== q.id) q.id = newId;

    // Language fields
    LANGS.forEach(l => {
        const qEl = document.getElementById('q_' + l.code);
        const aEl = document.getElementById('a_' + l.code);
        if (!qEl || !aEl) return;
        if (!q[l.code]) q[l.code] = {};
        q[l.code].question = qEl.value;
        q[l.code].answer   = aEl.value;
    });
}

function markModified() {
    if (currentIndex < 0) return;
    const q = questions[currentIndex];
    modifiedIds.add(q.id);
    updateStats();
}

// â”€â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function navigateQ(dir) {
    saveCurrentToMemory();
    const next = currentIndex + dir;
    if (next >= 0 && next < questions.length) selectQuestion(next);
}

function jumpToId() {
    const id = parseInt(document.getElementById('idJumpInput').value);
    const idx = questions.findIndex(q => q.id === id);
    if (idx >= 0) {
        saveCurrentToMemory();
        selectQuestion(idx);
    } else {
        toast(`Question with ID ${id} not found`, 'error');
    }
}

// â”€â”€â”€ ADD / DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addNewQuestion() {
    saveCurrentToMemory();
    const maxId = questions.reduce((m, q) => Math.max(m, q.id || 0), 0);
    const newQ = {
        id: maxId + 1,
        he: { question: '', answer: '' },
        ru: { question: '', answer: '' },
        en: { question: '', answer: '' },
        ar: { question: '', answer: '' },
        question_media: [],
        answer_media: []
    };
    questions.push(newQ);
    modifiedIds.add(newQ.id);
    updateStats();
    renderList();
    selectQuestion(questions.length - 1);
    toast('New question added â€” fill in the fields', 'info');
}

function deleteCurrentQuestion() {
    if (currentIndex < 0) return;
    const q = questions[currentIndex];
    if (!confirm(`Delete question #${q.id}? This cannot be undone here.`)) return;
    modifiedIds.delete(q.id);
    questions.splice(currentIndex, 1);
    currentIndex = Math.min(currentIndex, questions.length - 1);
    updateStats();
    renderList();
    if (currentIndex >= 0) selectQuestion(currentIndex);
    else { showPlaceholder(); document.getElementById('deleteBtn').disabled = true; }
    toast('Question deleted', 'info');
}

// â”€â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getJSON() {
    saveCurrentToMemory();
    return JSON.stringify(questions, null, 2);
}

function downloadJSON() {
    const json = getJSON();
    const blob = new Blob([json], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = currentFile + '.json';
    a.click();
    modifiedIds.clear();
    updateStats();
    toast(`Downloaded ${currentFile}.json â€” upload to GitHub`, 'success');
}

function copyJSON() {
    const json = getJSON();
    navigator.clipboard.writeText(json).then(() => {
        toast('JSON copied to clipboard', 'success');
    }).catch(() => {
        // fallback
        const ta = document.createElement('textarea');
        ta.value = json;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        toast('JSON copied to clipboard', 'success');
    });
}

// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPlaceholder() {
    document.getElementById('editorMain').innerHTML = `
    <div class="editor-placeholder">
        <div class="icon">âœï¸</div>
        <p>Select a question from the list<br>to start editing.</p>
        <p style="margin-top:12px; font-size:0.8em; color:var(--text-dim);">
            Or <a href="#" onclick="addNewQuestion(); return false;" style="color:var(--accent);">add a new question</a>.
        </p>
    </div>`;
}

function escHtml(str) {
    return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;');
}

let toastTimer;
function toast(msg, type = 'info') {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'toast ' + type;
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.classList.add('hidden'), 3000);
}

// Save on keyboard shortcut Ctrl+S
document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        if (questions.length) downloadJSON();
    }
});
</script>
</body>
</html>
